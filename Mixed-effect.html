<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Lecture 5: Mixed-effect regression</title>
    <meta charset="utf-8" />
    <meta name="author" content="Dr Nemanja Vaci" />
    <meta name="date" content="2021-12-03" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">

class: center, inverse
background-image: url("SumerianStand2.jpg")
background-size: contain
---

&lt;style type="text/css"&gt;
body, td {
   font-size: 15px;
}
code.r{
  font-size: 15px;
}
pre {
  font-size: 20px
}
.huge .remark-code { /*Change made here*/
  font-size: 200% !important;
}
.tiny .remark-code { /*Change made here*/
  font-size: 80% !important;
}


&lt;/style&gt;

## Press record

---

## Corrections from the previous lecture

---

## R code

[LINK](https://nvaci.github.io/Lecture_5_code/Lecture_5Rcode.html)

---

## Regression
.pull-left[
Gaussian distribution:
`\(y_{i} \sim \mathcal{N^{iid}}(\mu_{i},\sigma)\)` &lt;br/&gt; &lt;br/&gt;
`\(\mu_{i} = \alpha+\beta*x_i\)` &lt;br/&gt;&lt;br/&gt; 
Model mean and standard deviation &lt;br/&gt; &lt;br/&gt; 
&lt;br/&gt;
&lt;br/&gt;
a) Errors: `\(\mathcal{N}^{iid}(0,\sigma^2)\)` &lt;br/&gt; &lt;br/&gt;
b) Linearity and additivity &lt;br/&gt; &lt;br/&gt;
c) Validity &lt;br/&gt; &lt;br/&gt;
d) Lack of perfect multicolinearity &lt;br/&gt; &lt;br/&gt;
]
.pull-right[
We rarely have that: [Link](http://mfviz.com/hierarchical-models/)
]
---

## Correlated observations

Nested structures: observations nested hierarchically under general groups (eg. answers of pupils in the UK) &lt;br/&gt;
 - Pupils are nested in ther classes &lt; schools &lt; counties &lt;br/&gt; &lt;br/&gt;
 
Repeated measurements: observations clustered within the participants &lt;br/&gt; 
- Participants answering on a number of questions in an experiment &lt;br/&gt;
- NBA players contributing multiple observations of their performance throughout their career &lt;br/&gt;&lt;br/&gt;

Clustering of the observations that are not nested: &lt;br/&gt;
- Questionnaire that collects profession of people and their country &lt;br/&gt; &lt;br/&gt;
---

## Multilevel models 

Generalization of regression `\((y_i=\alpha+\beta*x_i+\epsilon_i)\)`, where we allow adjustments of: &lt;br/&gt;&lt;br/&gt;
- Intercept: `\(y_i = \alpha_{j[i]}+\beta*x_i+\epsilon_i\)` &lt;br/&gt;&lt;br/&gt;
- Slope: `\(y_i=\alpha*\beta_{j[i]}*x_i+\epsilon_i\)` &lt;br/&gt;&lt;br/&gt;
- Both: `\(y_i=\alpha_{j[i]}*\beta_{j[i]}*x_i+\epsilon_i\)`

---

## Babies




```r
knitr::kable(head(Babies), format = 'html')
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; Country_id &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; T_0s &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; T_1s &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Age &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Weight &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Gender &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; RunningDist &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 67.71321 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4.521216 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3861.479 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Girls &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 710.8318 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 67.71321 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4.521216 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 13 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3679.318 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Boys &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 783.3042 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 67.71321 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4.521216 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4428.437 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Girls &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 517.1590 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 67.71321 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4.521216 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4156.922 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Girls &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 588.9336 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 67.71321 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4.521216 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4611.231 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Boys &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 545.8017 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 67.71321 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4.521216 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3436.836 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Boys &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 541.9700 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;


```r
table(Babies$Country_id)
```

```
## 
##  1  2  3  4  5  6  7  8  9 10 
## 20 20 20 20 20 20 20 20 20 20
```
---

## Analysis of the data

1. Complete pooling - take into account all observations, without categorical information &lt;br/&gt;&lt;br/&gt;
2. No pooling - adjust regression for each category  &lt;br/&gt; &lt;br/&gt;
3. Partial pooling - use categories to adjust individual estimates &lt;br/&gt; &lt;br/&gt;

---

## Complete pooling

Linear model where we ignore information about the countries: 


```r
mod1CP&lt;-lm(RunningDist~Age, data=Babies)
summary(mod1CP)
```

```
## 
## Call:
## lm(formula = RunningDist ~ Age, data = Babies)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -309.65 -127.68  -39.48   76.39  622.61 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  387.262     29.575  13.094  &lt; 2e-16 ***
## Age           11.695      1.643   7.116 1.99e-11 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 195.4 on 198 degrees of freedom
## Multiple R-squared:  0.2037,	Adjusted R-squared:  0.1996 
## F-statistic: 50.64 on 1 and 198 DF,  p-value: 1.991e-11
```

&lt;style type="text/css"&gt;
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 100px;
}
&lt;/style&gt;

&lt;style type="text/css"&gt;
.scroll-100 {
  max-height: 100px;
  overflow-y: auto;
  background-color: inherit;
}
&lt;/style&gt;
---

## Complete pooling

Potential problems: 


```r
par(mfrow=c(1,1), bty='n',mar = c(5, 4, .1, .1), cex=1.1, pch=16)
plot(resid(mod1CP), ylab='Residuals', xlab='Index')
```

&lt;img src="Mixed-effect_files/figure-html/unnamed-chunk-7-1.png" style="display: block; margin: auto;" /&gt;

---

## No pooling

Linear model where we estimates parameters for each country separately:  


```r
mod1NP&lt;-lm(RunningDist~Age+factor(Country_id)-1, data=Babies)
summary(mod1NP)
```

```
## 
## Call:
## lm(formula = RunningDist ~ Age + factor(Country_id) - 1, data = Babies)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -282.176  -46.913   -2.057   41.743  259.480 
## 
## Coefficients:
##                      Estimate Std. Error t value Pr(&gt;|t|)    
## Age                   12.0933     0.7851  15.404   &lt;2e-16 ***
## factor(Country_id)1  646.5979    23.0742  28.023   &lt;2e-16 ***
## factor(Country_id)2  335.1276    22.7026  14.762   &lt;2e-16 ***
## factor(Country_id)3  381.3623    25.4322  14.995   &lt;2e-16 ***
## factor(Country_id)4  243.0205    24.8691   9.772   &lt;2e-16 ***
## factor(Country_id)5  738.8460    23.6285  31.269   &lt;2e-16 ***
## factor(Country_id)6  220.8993    24.0903   9.170   &lt;2e-16 ***
## factor(Country_id)7  256.4331    24.0903  10.645   &lt;2e-16 ***
## factor(Country_id)8  469.6384    23.9834  19.582   &lt;2e-16 ***
## factor(Country_id)9  221.2246    22.3018   9.920   &lt;2e-16 ***
## factor(Country_id)10 296.1329    23.4261  12.641   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 90.15 on 189 degrees of freedom
## Multiple R-squared:  0.9796,	Adjusted R-squared:  0.9784 
## F-statistic: 824.4 on 11 and 189 DF,  p-value: &lt; 2.2e-16
```

---

## No pooling


```r
par(mfrow=c(1,1), bty='n',mar = c(5, 4, .1, .1), cex=1.1, pch=16)
plot(resid(mod1NP), ylab='Residuals',xlab='Index')
```

&lt;img src="Mixed-effect_files/figure-html/unnamed-chunk-9-1.png" style="display: block; margin: auto;" /&gt;

---

## Trade-offs between the approaches

Complete pooling ignores variation between the categorical outcomes &lt;br/&gt; &lt;br/&gt;

No pooling can overfit the data within each group, especially in the case when there are few observations per group or extreme cases &lt;br/&gt; &lt;br/&gt;

---

## Partial pooling in multilevel model

No predictors situation: &lt;br/&gt; 

The goal is to estimate average running distance for all babies in country `\(j\)`, for which we have a random sample size of `\(n_j\)` &lt;br/&gt; &lt;br/&gt;

Multilevel estimates for a given country `\(j\)` can be approximated as a weighted average of the mean of observations in the country (the unpooled estimate, `\(y_j\)`) and the mean over all countries (completely pooled estimate `\(y_{all}\)`) &lt;br/&gt; &lt;br/&gt;


---

## Intercept

&lt;img src="Multi.png" width="40%" style="display: block; margin: auto;" /&gt;

`\(n_j\)` - number of babies in a country &lt;br/&gt;
`\(\sigma^2_y\)` - within country variance in running distance &lt;br/&gt;
`\(\sigma^2_\alpha\)` - variance among the average running distance of the different countries &lt;br/&gt; &lt;br/&gt;

---

## Shrinkage estimator 

Averages from countries with smaller sample size cary less information, and the weighting pulls multilevel estimates closer to the overall average. &lt;br/&gt;
If the `\(n_j=0\)` then overal average &lt;br/&gt;&lt;br/&gt;

Averages from countries with larger sample size carry more information, and the multilevel estimates are close to the country averages. &lt;br/&gt;
If `\(n_j-&gt;\infty\)` then country average &lt;br/&gt;&lt;br/&gt;

Every other time, multilevel estimates are between the two extremes &lt;br/&gt;

---

## Multilevel model: intercept

`$$y_i \sim N(\alpha_{j[i]}+\beta*x_i, \sigma^2_y)$$` 
&lt;br/&gt;
Soft constraint: `\(\alpha_j \sim N(\mu_\alpha, \sigma^2_\alpha)\)` &lt;br/&gt;&lt;br/&gt;

---

## Intercept adjustment: R


```r
#install.packages('lme4')
require(lme4)

mult1&lt;-lmer(RunningDist~Age+(1|Country_id), data=Babies)
summary(mult1)
```

```
## Linear mixed model fit by REML ['lmerMod']
## Formula: RunningDist ~ Age + (1 | Country_id)
##    Data: Babies
## 
## REML criterion at convergence: 2399
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -3.08265 -0.51390 -0.02426  0.47520  2.92714 
## 
## Random effects:
##  Groups     Name        Variance Std.Dev.
##  Country_id (Intercept) 33092    181.91  
##  Residual                8128     90.15  
## Number of obs: 200, groups:  Country_id, 10
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept) 381.0106    59.2094   6.435
## Age          12.0881     0.7847  15.404
## 
## Correlation of Fixed Effects:
##     (Intr)
## Age -0.211
```

---

## Results: intercept adjustment

`$$y_i \sim N(\alpha_{j[i]}+12.08*x_i, 90.15)$$` 

&lt;br/&gt;
Soft constraint: `\(\alpha_j \sim N(381.01, 181.91)\)` &lt;br/&gt;&lt;br/&gt;

Variation between the countries versus within the country:&lt;br/&gt;
`\(\frac{\sigma^2_{\alpha}}{\sigma^2_y} = \frac{181.91}{90.15}=2\)` &lt;br/&gt;&lt;br/&gt;

Our variance between the countries is 2x larger (more informative) than variance within countries - our model will always benefit from inclusion of the random adjustments

---

## Multilevel model: intercept and slope adjustments 


`$$y_i \sim N(\alpha_{j[i]}+\beta_{j[i]}*x_i, \sigma^2_y)$$` 
&lt;br/&gt;
Soft constraint: &lt;br/&gt;

&lt;img src="insl.png" width="50%" style="display: block; margin: auto;" /&gt;

---

## Intercept and slope adjustments: R



```r
mult2&lt;-lmer(RunningDist~Age+(1+Age|Country_id), data=Babies)
summary(mult2)
```

```
## Linear mixed model fit by REML ['lmerMod']
## Formula: RunningDist ~ Age + (1 + Age | Country_id)
##    Data: Babies
## 
## REML criterion at convergence: 1349.4
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.4137 -0.6028 -0.0925  0.6037  3.3570 
## 
## Random effects:
##  Groups     Name        Variance Std.Dev. Corr
##  Country_id (Intercept) 2010.65  44.840       
##             Age          111.93  10.580   0.33
##  Residual                 23.93   4.892       
## Number of obs: 200, groups:  Country_id, 10
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)  399.652     14.202   28.14
## Age           11.008      3.346    3.29
## 
## Correlation of Fixed Effects:
##     (Intr)
## Age 0.330
```

---

## Fixed effects

Many different definitions: [LINK](https://stats.stackexchange.com/questions/4700/what-is-the-difference-between-fixed-effect-random-effect-and-mixed-effect-mode) &lt;br/&gt;


```r
fixef(mult2)
```

```
## (Intercept)         Age 
##   399.65175    11.00775
```

---

## Random effects 


```r
ranef(mult2)
```

```
## $Country_id
##    (Intercept)        Age
## 1     69.57041  13.487071
## 2    -29.63758  -1.536129
## 3    -37.81309   2.075458
## 4     67.50182 -11.000094
## 5     38.32357  20.248860
## 6     17.97654 -10.625830
## 7    -32.89473  -5.480356
## 8    -14.06215   6.164935
## 9    -48.00096  -9.647232
## 10   -30.96383  -3.686683
## 
## with conditional variances for "Country_id"
```

---

## Why multilevel modelling

- Helps us with better inference about fixed effects
- Interest in between group effects
- Better inferences about levels of group not included in the sample &lt;br/&gt;&lt;br/&gt;&lt;br/&gt;

- Deals better with the non-normality of outcomes
- Deals better with outliers (shrinks them towards the mean)
- Deals better with unequal number of observations per group

---

## When multilevel models = linear regression

Very little group-level variation - complete pooling &lt;br/&gt; &lt;br/&gt;

Too much group-level variation - no pooling &lt;br/&gt;&lt;br/&gt;

We can build complete or no pooling model (next slide), but multilevel model automatically adjusts estimates for both groups, ones close to complete pooling and ones close to no pooling &lt;br/&gt;&lt;br/&gt;  

???
How many groups/observations? - understanding partial pooling as a compromise between complete and no pooling indicates that the discussion about exact number of groups and observations is misguided. With few groups, we get classical regression - complete pooling and our multilevel model should be at least as good as linear regression. Having only two observations per group or even one observation in most of the groups might result in imprecise estimate of between group variance, but it should provide partial information that allows better estimation of parameters. 
---

## No pooling: 2


```r
mod1NP2&lt;-lm(RunningDist~Age*factor(Country_id)-1, data=Babies)
summary(mod1NP2)[4]
```

```
## $coefficients
##                            Estimate Std. Error    t value      Pr(&gt;|t|)
## Age                       24.489579  0.1273112  192.35994 2.623964e-210
## factor(Country_id)1      469.331037  2.1238473  220.98153 4.179553e-221
## factor(Country_id)2      369.926521  2.3538825  157.15590 1.337919e-194
## factor(Country_id)3      361.521752  3.5548706  101.69758 5.775693e-161
## factor(Country_id)4      467.649653  3.0302334  154.32793 3.431913e-193
## factor(Country_id)5      437.964345  2.0929519  209.25677 7.352799e-217
## factor(Country_id)6      417.770998  2.4320250  171.77907 1.648858e-201
## factor(Country_id)7      366.677101  2.5114917  145.99973 6.886336e-189
## factor(Country_id)8      385.492273  2.4490023  157.40789 1.004817e-194
## factor(Country_id)9      351.585467  2.0343006  172.82867 5.544225e-202
## factor(Country_id)10     368.627039  2.1004179  175.50176 3.556781e-203
## Age:factor(Country_id)2  -15.012744  0.2019115  -74.35308 4.665983e-137
## Age:factor(Country_id)3  -11.391698  0.2133982  -53.38236 2.727194e-112
## Age:factor(Country_id)4  -24.505671  0.1985354 -123.43222 6.831701e-176
## Age:factor(Country_id)5    6.768155  0.1706634   39.65791  6.865861e-91
## Age:factor(Country_id)6  -24.114839  0.1814550 -132.89708 1.322168e-181
## Age:factor(Country_id)7  -18.958425  0.1852506 -102.33933 1.897456e-161
## Age:factor(Country_id)8   -7.311926  0.1836773  -39.80855  3.719432e-91
## Age:factor(Country_id)9  -23.125574  0.1900993 -121.64998 9.080362e-175
## Age:factor(Country_id)10 -17.165635  0.1735666  -98.89943 8.025977e-159
```

---

## Residuals (no pooling versus multilevel model)


```r
par(mfrow=c(2,1), bty='n',mar = c(5, 4, .1, .1), cex=1.1,pch=16)
plot(resid(mult2))
plot(resid(mod1NP2))
```

&lt;img src="Mixed-effect_files/figure-html/unnamed-chunk-17-1.png" style="display: block; margin: auto;" /&gt;

---
class: inverse, middle, center
# Random effect structure 
---
## Specification of the structure

In all R packages, random effect structure can be specified using: &lt;br/&gt;&lt;br/&gt;

object &lt;- lmer(Dependent ~ Fixed (predictor) + __(1+|...)__, data=data) &lt;br/&gt;&lt;br/&gt;

- (1|Factor) = intercept adjustments for each level of factor &lt;br/&gt;&lt;br/&gt;
- (1+Predictor|Factor) = Intercept for each level of factor and slope adjustment for Predictor for each level of factor &lt;br/&gt;&lt;br/&gt;
- (0 + Predictor|Factor) or (Predictor - 1|Factor) = Slope adjustment for Predictor for reach level of factor &lt;br/&gt;&lt;br/&gt;


???
LMERs cheat sheet: &lt;br/&gt;&lt;br/&gt; 
- [LINK 1](https://stats.stackexchange.com/a/13173) &lt;br/&gt;&lt;br/&gt;
- [LINK 2](https://stats.stackexchange.com/a/61466)

---

## Nested effects

&lt;img src="nested.png" width="80%" style="display: block; margin: auto;" /&gt;
 &lt;br/&gt;&lt;br/&gt;
 
Random effect specification: (1|Country/Region) &lt;br/&gt;&lt;br/&gt;
Responses are nested within regions, that are further nested within Countries &lt;br/&gt;&lt;br/&gt; 

---

## Crossed random effects

&lt;img src="crossed.png" width="50%" style="display: block; margin: auto;" /&gt;
 &lt;br/&gt;&lt;br/&gt;
 
Random effect specification: (1|Country) + (1|Region) &lt;br/&gt;&lt;br/&gt;
Responses have multimembership status, they are nested in a combination of countries  &lt;br/&gt;&lt;br/&gt; 

---

## Crossed random effects 2

&lt;img src="crossed2.png" width="40%" style="display: block; margin: auto;" /&gt;

In the experimental situations (psycholinguistics): this will be the case. Responses in experimental paradigm are nested in two random structures simultaneously: participants and stimuli 

---

## How to decide what to include

There are no recipes, except that you need to think about your model and what it does &lt;br/&gt;&lt;br/&gt; 

There is some advice from the experts and it is that we should keep it maximal! [LINK](https://talklab.psy.gla.ac.uk/KeepItMaximalR2.pdf) &lt;br/&gt;&lt;br/&gt;

However, this is not always possible &lt;br/&gt;&lt;br/&gt; 

---

## Output of the model


```r
mult2&lt;-lmer(RunningDist~Age+(1+Age|Country_id), data=Babies)
print(summary(mult2), cor=F)
```

```
## Linear mixed model fit by REML ['lmerMod']
## Formula: RunningDist ~ Age + (1 + Age | Country_id)
##    Data: Babies
## 
## REML criterion at convergence: 1349.4
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.4137 -0.6028 -0.0925  0.6037  3.3570 
## 
## Random effects:
##  Groups     Name        Variance Std.Dev. Corr
##  Country_id (Intercept) 2010.65  44.840       
##             Age          111.93  10.580   0.33
##  Residual                 23.93   4.892       
## Number of obs: 200, groups:  Country_id, 10
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)  399.652     14.202   28.14
## Age           11.008      3.346    3.29
```


???

REML: [LINK](https://towardsdatascience.com/maximum-likelihood-ml-vs-reml-78cf79bef2cf) &lt;br/&gt;&lt;br/&gt; 
Intercept: Average predicted score for Running distance for Children at birth&lt;br/&gt;&lt;br/&gt; 
Age: If we compare Babies that differ in their age by 1 month, we expect to see that older babies are run by the size of `\(\beta\)` on average &lt;br/&gt;&lt;br/&gt;  
---

## Significance testing: fixed effects


```r
#install.packages('lmerTest')
require(lmerTest)
mult2&lt;-lmer(RunningDist~Age+(1+Age|Country_id), data=Babies)
print(summary(mult2), cor=F)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: RunningDist ~ Age + (1 + Age | Country_id)
##    Data: Babies
## 
## REML criterion at convergence: 1349.4
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.4137 -0.6028 -0.0925  0.6037  3.3570 
## 
## Random effects:
##  Groups     Name        Variance Std.Dev. Corr
##  Country_id (Intercept) 2010.65  44.840       
##             Age          111.93  10.580   0.33
##  Residual                 23.93   4.892       
## Number of obs: 200, groups:  Country_id, 10
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)  399.652     14.202   8.998   28.14 4.41e-10 ***
## Age           11.008      3.346   9.001    3.29  0.00938 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

???
Satterweight approximation of degrees of freedom: [LINK](https://link.springer.com/article/10.3758/s13428-016-0809-y)
---

## Significance testing: random effects 

We are not interested in understanding exactly which levels of random factors are different in comparison to the mean &lt;br/&gt;&lt;br/&gt; 

We are interested in making correct estimates of our coefficients &lt;br/&gt;&lt;br/&gt; 
However, we can compare whether random structure adds more information by comparing the nested models: &lt;br/&gt;


```r
anova(mult1, mult2)
```

```
## refitting model(s) with ML (instead of REML)
```

```
## Data: Babies
## Models:
## mult1: RunningDist ~ Age + (1 | Country_id)
## mult2: RunningDist ~ Age + (1 + Age | Country_id)
##       npar    AIC    BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)    
## mult1    4 2418.2 2431.4 -1205.1   2410.2                         
## mult2    6 1372.6 1392.4  -680.3   1360.6 1049.6  2  &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

---
class: inverse, middle, center
# Practical aspect
---

## Data

Relation between digital-screen use and the mental well-being of adolescents: [LINK](https://journals.sagepub.com/doi/10.1177/0956797616678438)  &lt;br/&gt; &lt;br/&gt;
.pull-left[
Outcome:
- Mental well-being: mwbi  &lt;br/&gt;&lt;br/&gt;&lt;br/&gt;

Predictors:
- TV weekdays: Watchwk_adj  &lt;br/&gt;
- TV weekends: Watchwe_adj  &lt;br/&gt;
- Computer weekdays: Compwk_adj  &lt;br/&gt;
- Computer weekends: Compwe_adj  &lt;br/&gt;
- Smartphones weekday: Smartwk_adj  &lt;br/&gt;
- Smartphones weekends: Smartwe_adj  &lt;br/&gt;
- Total: sum of those
]
.pull-right[
Ethnicity: Ethnicg &lt;br/&gt; 
Region: Region &lt;br/&gt;
Local area: LANAME &lt;br/&gt;&lt;br/&gt;&lt;br/&gt;

Factors:
male &lt;br/&gt;
minority &lt;br/&gt;
deprived &lt;br/&gt;
]

---

## Reading the data in R


```r
#install.packages('foreign')
require(foreign)
mwell&lt;-read.spss('data.sav', to.data.frame = T)
dim(mwell)
```

```
## [1] 120115     74
```

```r
mwell$Total=mwell$Watchwe_adj+mwell$Watchwk_adj+mwell$Comphwe_adj+mwell$Comphwk_adj+mwell$Smartwe_adj+mwell$Smartwk_adj
```

---


## Missing data

Outcome:


```r
table(is.na(mwell$mwb))
```

```
## 
##  FALSE   TRUE 
## 102580  17535
```

Predictor: 


```r
table(is.na(mwell$Watchwk))
```

```
## 
##  FALSE   TRUE 
## 117638   2477
```

---

## Visualisations of the raw data


```r
par(mfrow=c(1,2), bty='n',mar = c(5, 4, .1, .1), cex=1.1,pch=16)
plot(density(mwell$mwb, na.rm=TRUE), main='')
plot(density(mwell$Total, na.rm = T), main='')
```

&lt;img src="Mixed-effect_files/figure-html/unnamed-chunk-27-1.png" style="display: block; margin: auto;" /&gt;

---

## Subsetting the data - excluding NAs


```r
mwell2=mwell[!is.na(mwell$mwb) &amp; !is.na(mwell$Total),]
dim(mwell2)
```

```
## [1] 98853    75
```
---

## Scatter plots


```r
cor(mwell2$mwb, mwell2$Total)
```

```
## [1] -0.1724534
```

```r
par(mfrow=c(1,1), bty='n',mar = c(5, 4, .1, .1), cex=1.1,pch=16)
plot(mwell2$Total[1:500], mwell2$mwb[1:500])
```

&lt;img src="Mixed-effect_files/figure-html/unnamed-chunk-29-1.png" style="display: block; margin: auto;" /&gt;

---

## Observations for each category


```r
table(mwell2$Ethnicg)
```

```
## 
##            White            Mixed            Asian            Black 
##            76428             3827             9537             4413 
## Other or unknown 
##             4648
```

```r
table(mwell2$REGION)
```

```
## 
## East Midlands                                                            
##                                                                     6440 
## East of England                                                          
##                                                                     7612 
## London                                                                   
##                                                                    18524 
## North East                                                               
##                                                                     6826 
## North West                                                               
##                                                                    15276 
## South East                                                               
##                                                                    13160 
## South West                                                               
##                                                                    10105 
## West Midlands                                                            
##                                                                    10328 
## Yorkshire and the Humber                                                 
##                                                                    10582
```

---

## Observation for each category


```r
table(mwell2$LANAME)[1:10]
```

```
## 
## Barking and Dagenham                                                                                                        
##                                                                                                                         623 
## Barnet                                                                                                                      
##                                                                                                                         721 
## Barnsley                                                                                                                    
##                                                                                                                         645 
## Bath and North East Somerset                                                                                                
##                                                                                                                         549 
## Bedford                                                                                                                     
##                                                                                                                         575 
## Bexley                                                                                                                      
##                                                                                                                         678 
## Birmingham                                                                                                                  
##                                                                                                                         785 
## Blackburn with Darwen                                                                                                       
##                                                                                                                         491 
## Blackpool                                                                                                                   
##                                                                                                                         478 
## Bolton                                                                                                                      
##                                                                                                                         716
```

---

## Train and test dataset


```r
dt &lt;- sort(sample(nrow(mwell2), nrow(mwell2)*.7))
train &lt;- mwell2[dt,]
dim(train)
```

```
## [1] 69197    75
```

```r
test &lt;- mwell2[-dt,]
dim(test)
```

```
## [1] 29656    75
```

---

## Building the model: Random structure 1 


```r
MWmod1&lt;-lmer(mwb~(1|LANAME), data=train)
MWmod2&lt;-lmer(mwb~(1|LANAME)+(1|Ethnicg), data=train)
MWmod3&lt;-lmer(mwb~(1|REGION/LANAME)+(1|Ethnicg), data=train)
anova(MWmod1, MWmod2, MWmod3)
```

```
## refitting model(s) with ML (instead of REML)
```

```
## Data: train
## Models:
## MWmod1: mwb ~ (1 | LANAME)
## MWmod2: mwb ~ (1 | LANAME) + (1 | Ethnicg)
## MWmod3: mwb ~ (1 | REGION/LANAME) + (1 | Ethnicg)
##        npar    AIC    BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)  
## MWmod1    3 508203 508231 -254099   508197                       
## MWmod2    4 508204 508241 -254098   508196 1.0536  1    0.30467  
## MWmod3    5 508201 508247 -254096   508191 4.7898  1    0.02863 *
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

---

## Building the model: Fixed structure 1


```r
MWmod2a&lt;-lmer(mwb~Total+(1|LANAME)+(1|Ethnicg), data=train)
print(summary(MWmod2a), cor=F)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: mwb ~ Total + (1 | LANAME) + (1 | Ethnicg)
##    Data: train
## 
## REML criterion at convergence: 506027.5
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -4.0235 -0.6230  0.0689  0.6833  2.9984 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  LANAME   (Intercept)  0.197   0.4438  
##  Ethnicg  (Intercept)  0.231   0.4807  
##  Residual             87.631   9.3611  
## Number of obs: 69197, groups:  LANAME, 150; Ethnicg, 5
## 
## Fixed effects:
##               Estimate Std. Error         df t value Pr(&gt;|t|)    
## (Intercept)  5.117e+01  2.398e-01  4.932e+00   213.4 5.69e-11 ***
## Total       -2.077e-01  4.410e-03  6.840e+04   -47.1  &lt; 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

---

## Building the model: Fixed structure 2


```r
MWmod2b&lt;-lmer(mwb~Total+male+(1|LANAME)+(1|Ethnicg), data=train)
MWmod2c&lt;-lmer(mwb~Total*male+(1|LANAME)+(1|Ethnicg), data=train)
anova(MWmod2a, MWmod2b, MWmod2c)
```

```
## refitting model(s) with ML (instead of REML)
```

```
## Data: train
## Models:
## MWmod2a: mwb ~ Total + (1 | LANAME) + (1 | Ethnicg)
## MWmod2b: mwb ~ Total + male + (1 | LANAME) + (1 | Ethnicg)
## MWmod2c: mwb ~ Total * male + (1 | LANAME) + (1 | Ethnicg)
##         npar    AIC    BIC  logLik deviance   Chisq Df Pr(&gt;Chisq)    
## MWmod2a    5 506027 506073 -253009   506017                          
## MWmod2b    6 501718 501773 -250853   501706 4311.27  1  &lt; 2.2e-16 ***
## MWmod2c    7 501580 501644 -250783   501566  139.84  1  &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

---

## Results: Fixed structure 2


```r
print(summary(MWmod2c), cor=F)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: mwb ~ Total * male + (1 | LANAME) + (1 | Ethnicg)
##    Data: train
## 
## REML criterion at convergence: 501587.3
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -4.2217 -0.6172  0.0567  0.6679  3.3090 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  LANAME   (Intercept)  0.1644  0.4055  
##  Ethnicg  (Intercept)  0.2946  0.5428  
##  Residual             82.1824  9.0654  
## Number of obs: 69197, groups:  LANAME, 150; Ethnicg, 5
## 
## Fixed effects:
##                 Estimate Std. Error         df t value Pr(&gt;|t|)    
## (Intercept)    4.887e+01  2.768e-01  5.704e+00  176.54    7e-12 ***
## Total         -1.977e-01  5.881e-03  6.900e+04  -33.62   &lt;2e-16 ***
## maleYes        3.026e+00  1.585e-01  6.918e+04   19.09   &lt;2e-16 ***
## Total:maleYes  1.030e-01  8.702e-03  6.917e+04   11.83   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

---

## Building the model: Random structure 2


```r
MWmod3c&lt;-lmer(mwb~Total*male+(1+Total|LANAME)+(1|Ethnicg), data=train)
```

```
## Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
## unable to evaluate scaled gradient
```

```
## Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
## Model failed to converge: degenerate Hessian with 1 negative eigenvalues
```

```
## Warning: Model failed to converge with 1 negative eigenvalue: -1.2e+01
```


```r
MWmod3c&lt;-lmer(mwb~Total*male+(1|LANAME:male)+(1|Ethnicg), data=train)
anova(MWmod2c, MWmod3c)
```

```
## refitting model(s) with ML (instead of REML)
```

```
## Data: train
## Models:
## MWmod2c: mwb ~ Total * male + (1 | LANAME) + (1 | Ethnicg)
## MWmod3c: mwb ~ Total * male + (1 | LANAME:male) + (1 | Ethnicg)
##         npar    AIC    BIC  logLik deviance Chisq Df Pr(&gt;Chisq)
## MWmod2c    7 501580 501644 -250783   501566                    
## MWmod3c    7 501593 501657 -250789   501579     0  0
```

---

## Building the model: Random structure 3


```r
MWmod3c&lt;-lmer(mwb~Total*male+(1|LANAME)+(1|Ethnicg:male), data=train)
anova(MWmod2c, MWmod3c)
```

```
## refitting model(s) with ML (instead of REML)
```

```
## Data: train
## Models:
## MWmod2c: mwb ~ Total * male + (1 | LANAME) + (1 | Ethnicg)
## MWmod3c: mwb ~ Total * male + (1 | LANAME) + (1 | Ethnicg:male)
##         npar    AIC    BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)
## MWmod2c    7 501580 501644 -250783   501566                     
## MWmod3c    7 501572 501636 -250779   501558 8.0648  0
```

---

## Results: Full structure


```r
summary(MWmod3)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: mwb ~ (1 | REGION/LANAME) + (1 | Ethnicg)
##    Data: train
## 
## REML criterion at convergence: 508193.8
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -3.5910 -0.6150  0.0744  0.6889  2.4505 
## 
## Random effects:
##  Groups        Name        Variance Std.Dev.
##  LANAME:REGION (Intercept)  0.14431 0.3799  
##  REGION        (Intercept)  0.03884 0.1971  
##  Ethnicg       (Intercept)  0.02591 0.1610  
##  Residual                  90.45744 9.5109  
## Number of obs: 69197, groups:  LANAME:REGION, 150; REGION, 9; Ethnicg, 5
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)  47.5813     0.1211  5.2449   392.8 6.35e-13 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

---

## Visualisation of the random structure: 1


```r
require(sjPlot)
plot_model(MWmod3c, type='re', sort.est='sort.all', grid=FALSE)[1]
```

```
## [[1]]
```

&lt;img src="Mixed-effect_files/figure-html/unnamed-chunk-41-1.png" style="display: block; margin: auto;" /&gt;

---

## Visualisation of the random structure: 2


```r
plot_model(MWmod3c, type='re', sort.est='sort.all', grid=FALSE)[2]
```

```
## [[1]]
```

&lt;img src="Mixed-effect_files/figure-html/unnamed-chunk-42-1.png" style="display: block; margin: auto;" /&gt;

---

## Visualisation of the fixed effects


```r
plot_model(MWmod3c, type='int')
```

&lt;img src="Mixed-effect_files/figure-html/unnamed-chunk-43-1.png" style="display: block; margin: auto;" /&gt;

---

## Additional information - here be dragons

Significance of the random structure


```r
ranova(MWmod3c)
```

```
## ANOVA-like table for random-effects: Single term deletions
## 
## Model:
## mwb ~ Total + male + (1 | LANAME) + (1 | Ethnicg:male) + Total:male
##                    npar  logLik    AIC    LRT Df Pr(&gt;Chisq)    
## &lt;none&gt;                7 -250788 501591                         
## (1 | LANAME)          6 -250808 501628 38.953  1  4.342e-10 ***
## (1 | Ethnicg:male)    6 -250814 501640 51.457  1  7.319e-13 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

Explained variance - R2:


```r
#install.packages('MuMIn')
require(MuMIn)
r.squaredGLMM(MWmod3c)
```

```
##             R2m        R2c
## [1,] 0.08579352 0.09108678
```

---

## Prediction of the model


```r
train$predicted=predict(MWmod3c)
par(mfrow=c(1,1), bty='n',mar = c(5, 4, .1, .1), cex=1.1,pch=16)
plot(train$predicted, train$mwb)
```

&lt;img src="Mixed-effect_files/figure-html/unnamed-chunk-46-1.png" style="display: block; margin: auto;" /&gt;

---

## Mean squared error of prediction

Train data:


```r
MSE=mean((train$predicted-train$mwb)^2)
MSE
```

```
## [1] 82.06379
```

Test data: 


```r
test$predicted=predict(MWmod3c, newdata=test)
MSE2=mean((test$predicted-test$mwb)^2)
MSE2
```

```
## [1] 83.49368
```

---

## Making more complex model


```r
MWmod3d&lt;-lmer(mwb~poly(Total, degree=2, raw=T)*male+(1|LANAME)+(1|Ethnicg:male), data=train)
```

Train data:


```r
train$predicted2=predict(MWmod3d)
MSEa=mean((train$predicted2-train$mwb)^2)
MSEa
```

```
## [1] 82.04431
```

Test data: 


```r
test$predicted2=predict(MWmod3d, newdata=test)
MSE2b=mean((test$predicted2-test$mwb)^2)
MSE2b
```

```
## [1] 83.45186
```

---
## Important aspects: theory

- Why and when would we want to use multilevel models &lt;br/&gt;
- What can we include in our random structure - types of adjustments &lt;br/&gt;
- Multilevel models versus complete and no pooling &lt;br/&gt;
- Understanding how to specify random structure

---

## Important aspects: practice

- Building linear mixed-effect model
- Specifying random intercepts and slopes
- Comparing nested models 
- Interpreting coefficients from linear mixed-effect models

---
## Literature

Chapter 11, 12 and 13 of "Data Analysis Using Regression and Multilevel/Hierarchical Models" by Andrew Gelman and Jennifer Hill &lt;br/&gt; &lt;br/&gt;

---

# Thank you for your attention
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"ratio": "16:9",
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
